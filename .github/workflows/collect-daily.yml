# âš½ Soccer Brain - ì¼ë³„ ë°ì´í„° ìˆ˜ì§‘
# ê²½ê¸° ì¼ì •, ë¶€ìƒì, ë‚ ì”¨

name: ğŸ“… Daily Data Collection

on:
  schedule:
    # 06:00 KST = 21:00 UTC (ì „ë‚ ) â†’ ê²½ê¸° ì¼ì •
    - cron: "0 21 * * *"
    # 08:00 KST = 23:00 UTC (ì „ë‚ ) â†’ ë¶€ìƒì 1ì°¨
    - cron: "0 23 * * *"
    # 09:00 KST = 00:00 UTC â†’ ë‚ ì”¨
    - cron: "0 0 * * *"
    # 18:00 KST = 09:00 UTC â†’ ë¶€ìƒì 2ì°¨
    - cron: "0 9 * * *"

  workflow_dispatch:
    inputs:
      tasks:
        description: "ì‹¤í–‰í•  íƒœìŠ¤í¬ (ì‰¼í‘œ êµ¬ë¶„)"
        required: false
        default: "fixtures,injuries,weather"

concurrency:
  group: daily-collection
  cancel-in-progress: false

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install --ignore-scripts

      - name: ğŸ”§ Prisma ìƒì„±
        run: npx prisma generate

      - name: ğŸ¤– íƒœìŠ¤í¬ ê²°ì •
        id: decide
        run: |
          if [ -n "${{ github.event.inputs.tasks }}" ]; then
            TASKS=$(echo "${{ github.event.inputs.tasks }}" | tr ',' ' ')
          else
            # cron ì‹œê°„ëŒ€ì— ë”°ë¼ íƒœìŠ¤í¬ ìë™ ê²°ì •
            HOUR_UTC=$(date -u +%H)
            case $HOUR_UTC in
              21) TASKS="fixtures" ;;           # 06:00 KST
              23) TASKS="injuries" ;;           # 08:00 KST
              00) TASKS="weather" ;;            # 09:00 KST
              09) TASKS="injuries" ;;           # 18:00 KST
              *)  TASKS="fixtures injuries weather" ;;
            esac
          fi
          echo "tasks=$TASKS" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ì‹¤í–‰: $TASKS"

      - name: ğŸ¤– ë°ì´í„° ìˆ˜ì§‘
        run: npx tsx scripts/collect.ts ${{ steps.decide.outputs.tasks }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          API_SPORTS_KEY: ${{ secrets.API_SPORTS_KEY }}
