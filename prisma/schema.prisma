generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model League {
  id          BigInt   @id @default(autoincrement())
  apiLeagueId Int      @unique
  name        String
  country     String?
  season      Int
  enabled     Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fixtures  Fixture[]
  standings Standing[]

  @@index([enabled, priority])
}

model Team {
  id        BigInt   @id @default(autoincrement())
  apiTeamId Int      @unique
  name      String
  shortName String?
  logoUrl   String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homeFixtures             Fixture[]                 @relation("HomeTeam")
  awayFixtures             Fixture[]                 @relation("AwayTeam")
  stats                    TeamMatchStat[]
  fixtureLineups           FixtureLineup[]
  fixtureTeamStatSnapshots FixtureTeamStatSnapshot[]
  lineupPlayers            FixtureLineupPlayer[]
  injuries                 FixtureInjury[]
  predictedLineups         FixturePredictedLineup[]
  standings                Standing[]
}

// ë¦¬ê·¸ ìˆœìœ„í‘œ
model Standing {
  id           BigInt   @id @default(autoincrement())
  
  league       League   @relation(fields: [leagueId], references: [id])
  leagueId     BigInt
  
  team         Team     @relation(fields: [teamId], references: [id])
  teamId       BigInt
  
  season       Int
  rank         Int
  points       Int      @default(0)
  played       Int      @default(0)
  won          Int      @default(0)
  drawn        Int      @default(0)
  lost         Int      @default(0)
  goalsFor     Int      @default(0)
  goalsAgainst Int      @default(0)
  goalDiff     Int      @default(0)
  form         String?  // "WWDLW" í˜•íƒœ
  
  updatedAt    DateTime @updatedAt
  
  @@unique([leagueId, teamId, season])
  @@index([teamId, season])
  @@index([leagueId, season, rank])
}

model Fixture {
  id           BigInt @id @default(autoincrement())
  apiFixtureId Int    @unique

  league   League @relation(fields: [leagueId], references: [id])
  leagueId BigInt
  season   Int

  kickoffAt DateTime
  status    String

  homeTeam   Team   @relation("HomeTeam", fields: [homeTeamId], references: [id])
  homeTeamId BigInt
  awayTeam   Team   @relation("AwayTeam", fields: [awayTeamId], references: [id])
  awayTeamId BigInt

  homeGoals Int?
  awayGoals Int?

  venueName String?
  venueCity String?

  venueLat Float?
  venueLon Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stats      TeamMatchStat[]
  prediction Prediction?

  weather          FixtureWeather?
  odds             FixtureOdds?
  lineups          FixtureLineup[]
  teamStats        FixtureTeamStatSnapshot[]
  lineupPlayers    FixtureLineupPlayer[]
  injuries         FixtureInjury[]
  predictedLineups FixturePredictedLineup[]
  featureSnapshot FixtureFeatureSnapshot?
  bookmakerOdds   BookmakerOdds[]


  @@index([leagueId, kickoffAt])
  @@index([kickoffAt])
}

model TeamMatchStat {
  id BigInt @id @default(autoincrement())

  fixture   Fixture @relation(fields: [fixtureId], references: [id])
  fixtureId BigInt

  team   Team   @relation(fields: [teamId], references: [id])
  teamId BigInt

  isHome       Boolean
  goalsFor     Int
  goalsAgainst Int
  playedAt     DateTime

  createdAt DateTime @default(now())

  @@unique([fixtureId, teamId])
  @@index([teamId, playedAt])
}

model Prediction {
  id BigInt @id @default(autoincrement())

  fixture   Fixture @relation(fields: [fixtureId], references: [id])
  fixtureId BigInt  @unique

  modelVersion String

  lambdaHome Decimal
  lambdaAway Decimal

  pHome Decimal
  pDraw Decimal
  pAway Decimal

  pOver25  Decimal
  pUnder25 Decimal

  evidenceJson    Json?
  reliabilityJson Json?

  createdAt DateTime @default(now())

  @@index([modelVersion, createdAt])
}

model FixtureWeather {
  id        BigInt  @id @default(autoincrement())
  fixture   Fixture @relation(fields: [fixtureId], references: [id])
  fixtureId BigInt  @unique

  // UIìš© í•µì‹¬ í•„ë“œ(ìœ ì§€)
  condition String?
  tempC     Float?
  icon      String?

  // âœ… ë¶„ì„/ëª¨ë¸ë§ìš© í™•ì¥ í•„ë“œ(ì¶”ê°€)
  provider        String? // open-meteo/openweather ë“± (sourceì™€ ì—­í•  ê²¹ì¹˜ë©´ ë‚˜ì¤‘ì— ì •ë¦¬ ê°€ëŠ¥)
  timezone        String? // API timezone
  observedAt      DateTime? // kickoffAtì— ê°€ì¥ ê·¼ì ‘í•œ ë‚ ì”¨ ì‹œê°(UTC ê¸°ì¤€)
  weatherCode     Int? // Open-Meteo weathercode
  windKph         Float?
  windGustKph     Float?
  windDirDeg      Int?
  precipitationMm Float?
  humidityPct     Int?
  pressureHpa     Float?
  cloudCoverPct   Int?
  isDay           Boolean?

  // âœ… ìœ„ì¹˜(ì¶”ê°€) â€” venue ë¬¸ìì—´ ì§€ì˜¤ì½”ë”© or ë‚˜ì¤‘ì— venue ì¢Œí‘œ
  lat Float?
  lon Float?

  // ì¶œì²˜/ì›ë³¸ ë³´ì¡´(ìœ ì§€)
  source    String   @default("unknown")
  raw       Json?
  fetchedAt DateTime @default(now())

  @@index([fetchedAt])
  @@index([observedAt])
}

model FixtureOdds {
  id        BigInt  @id @default(autoincrement())
  fixture   Fixture @relation(fields: [fixtureId], references: [id])
  fixtureId BigInt  @unique

  // UIìš© í•µì‹¬ 1X2
  home Decimal?
  draw Decimal?
  away Decimal?

  // ì˜µì…˜: êµ­ë‚´/í•´ì™¸ ë¶„ë¦¬í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ì²˜ëŸ¼ Jsonë¡œ í™•ì¥
  domestic Json? // {home, draw, away, ...} ë˜ëŠ” ë°°ì—´
  overseas Json? // {home, draw, away, ...} ë˜ëŠ” ë°°ì—´

  // ì¶œì²˜/ì›ë³¸
  bookmaker String? // ì˜ˆ: "Bet365"
  raw       Json?
  fetchedAt DateTime @default(now())

  // ë°°ë‹¹ íˆìŠ¤í† ë¦¬ ê´€ê³„
  history OddsHistory[]

  @@index([fetchedAt])
}

// ë°°ë‹¹ ë³€ë™ íˆìŠ¤í† ë¦¬ (1ì‹œê°„ë§ˆë‹¤ ì €ì¥)
model OddsHistory {
  id        BigInt   @id @default(autoincrement())
  
  odds      FixtureOdds @relation(fields: [oddsId], references: [id], onDelete: Cascade)
  oddsId    BigInt
  
  home      Decimal
  draw      Decimal
  away      Decimal
  
  // ì´ì „ ëŒ€ë¹„ ë³€ë™
  homeChange Decimal?  // +0.05, -0.10 ë“±
  drawChange Decimal?
  awayChange Decimal?
  
  recordedAt DateTime @default(now())
  
  @@index([oddsId, recordedAt])
  @@index([recordedAt])
}

model FixtureLineup {
  id        BigInt                @id @default(autoincrement())
  fixture   Fixture               @relation(fields: [fixtureId], references: [id])
  fixtureId BigInt
  players   FixtureLineupPlayer[]

  team   Team   @relation(fields: [teamId], references: [id])
  teamId BigInt

  formation String?
  coachName String?

  isConfirmed Boolean @default(false)

  raw       Json?
  fetchedAt DateTime @default(now())

  source String @default("api-football") // âœ… nullable ì œê±°

  @@unique([fixtureId, teamId, isConfirmed, source])
  @@index([fixtureId])
  @@index([teamId])
}

model FixtureTeamStatSnapshot {
  id        BigInt  @id @default(autoincrement())
  fixture   Fixture @relation(fields: [fixtureId], references: [id])
  fixtureId BigInt

  team   Team   @relation(fields: [teamId], references: [id])
  teamId BigInt

  isHome Boolean

  // ğŸ”¥ ì¶”ê°€ë˜ëŠ” í•µì‹¬ ìŠ¤íƒ¯ ì»¬ëŸ¼ë“¤
  shotsTotal      Int?
  shotsOnTarget   Int?
  shotsOffTarget  Int?
  possessionPct   Float?
  passesTotal     Int?
  passesAccurate  Int?
  passAccuracyPct Float?
  fouls           Int?
  corners         Int?
  offsides        Int?
  yellowCards     Int?
  redCards        Int?
  tackles         Int?
  interceptions   Int?
  duelsTotal      Int?
  duelsWon        Int?
  saves           Int?
  xg              Float?

  // UI ë ˆì´ë”(ATT/DEF/ORG/FORM/GOAL)ëŠ” â€œì›ì²œ stats â†’ ì ìˆ˜í™”â€ë¡œ ë§Œë“œëŠ” ê²Œ ì¢‹ì•„ì„œ
  // ì¼ë‹¨ rawë¥¼ ì €ì¥ + ë‚˜ì¤‘ì— ì ìˆ˜ ì»¬ëŸ¼ ì¶”ê°€ ì¶”ì²œ
  raw       Json?
  fetchedAt DateTime @default(now())

  @@unique([fixtureId, teamId])
  @@index([teamId])
  @@index([fixtureId])
}

model Player {
  id          BigInt  @id @default(autoincrement())
  apiPlayerId Int     @unique
  name        String
  nationality String?
  position    String?
  photoUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineupRows FixtureLineupPlayer[]
  injuries   FixtureInjury[]
}

model FixtureLineupPlayer {
  id BigInt @id @default(autoincrement())

  fixtureId BigInt
  teamId    BigInt
  lineupId  BigInt
  playerId  BigInt

  isStarter Boolean
  number    Int?
  pos       String?
  grid      String?
  raw       Json?

  fixture Fixture       @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  team    Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lineup  FixtureLineup @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  player  Player        @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([lineupId, playerId]) // âœ… í•µì‹¬ ë³€ê²½
  @@index([fixtureId])
  @@index([teamId])
  @@index([playerId])
  @@index([lineupId])
}

model FixturePredictedLineup {
  id BigInt @id @default(autoincrement())

  fixtureId BigInt
  teamId    BigInt

  predicted Json
  evidence  Json?

  modelVersion String? // âœ… ì¶”ì²œ
  confidence   Float? // âœ… ì¶”ì²œ
  locked       Boolean @default(false) // âœ… ì¶”ì²œ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fixture Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([fixtureId, teamId])
  @@index([fixtureId])
  @@index([teamId])
}

model FixtureInjury {
  id BigInt @id @default(autoincrement())

  fixture   Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  fixtureId BigInt

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId BigInt

  apiPlayerId Int?
  playerName  String

  reason String?
  status String?

  source      String @default("api-football") // âœ… ì¶”ê°€
  externalKey String // âœ… ì¶”ê°€ (ì½”ë“œì—ì„œ ë§Œë“¤ì–´ ë„£ê¸°)

  raw       Json?
  fetchedAt DateTime @default(now())

  player   Player? @relation(fields: [playerId], references: [id])
  playerId BigInt?

  @@unique([source, externalKey]) // âœ… ë³€ê²½
  @@index([fixtureId])
  @@index([teamId])
  @@index([apiPlayerId])
}

model FixtureFeatureSnapshot {
  id        BigInt  @id @default(autoincrement())

  fixture   Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  fixtureId BigInt  @unique

  featureVersion Int      @default(1)
  nMatches        Int      @default(5)
  builtAt         DateTime @default(now())

  // ===== labels / ê¸°ë³¸ =====
  kickoffAt DateTime
  season    Int
  leagueId  BigInt

  homeTeamId BigInt
  awayTeamId BigInt

  homeGoals Int?
  awayGoals Int?

  // ===== injuries (í•´ë‹¹ ê²½ê¸° ê¸°ì¤€) =====
  homeInjuryCount Int @default(0)
  awayInjuryCount Int @default(0)

  // ===== weather (í•´ë‹¹ ê²½ê¸° ê¸°ì¤€) =====
  tempC           Float?
  precipitationMm Float?
  windKph         Float?
  humidityPct     Int?
  pressureHpa     Float?
  cloudCoverPct   Int?
  isDay           Boolean?

  // ===== recent N matches (íŒ€ ê¸°ì¤€ í‰ê· ) =====
  home_shotsTotal_avg      Float?
  home_shotsOnTarget_avg   Float?
  home_possessionPct_avg   Float?
  home_passesTotal_avg     Float?
  home_passAccuracyPct_avg Float?
  home_fouls_avg           Float?
  home_corners_avg         Float?
  home_yellowCards_avg     Float?
  home_redCards_avg        Float?
  home_xg_avg              Float?

  away_shotsTotal_avg      Float?
  away_shotsOnTarget_avg   Float?
  away_possessionPct_avg   Float?
  away_passesTotal_avg     Float?
  away_passAccuracyPct_avg Float?
  away_fouls_avg           Float?
  away_corners_avg         Float?
  away_yellowCards_avg     Float?
  away_redCards_avg        Float?
  away_xg_avg              Float?

  // ===== recent N matches (ë“ì‹¤ í‰ê· ) =====
  home_goalsFor_avg     Float?
  home_goalsAgainst_avg Float?
  away_goalsFor_avg     Float?
  away_goalsAgainst_avg Float?

    // ===== V2: ìƒëŒ€ ë¹„êµ(diff) =====
  shotsTotal_diff          Float?
  shotsOnTarget_diff       Float?
  possessionPct_diff       Float?
  passesTotal_diff         Float?
  passAccuracyPct_diff     Float?
  fouls_diff               Float?
  corners_diff             Float?
  yellowCards_diff         Float?
  redCards_diff            Float?
  xg_diff                  Float?
  injuryCount_diff         Int?
  goalsFor_diff            Float?
  goalsAgainst_diff        Float?

  // ===== V3: í™ˆ/ì›ì • ë¶„ë¦¬ ì„±ì  =====
  // í™ˆíŒ€ì˜ "í™ˆì—ì„œ" ì„±ì 
  home_goalsFor_atHome_avg     Float?
  home_goalsAgainst_atHome_avg Float?
  home_xg_atHome_avg           Float?
  home_wins_atHome_pct         Float?  // í™ˆ ìŠ¹ë¥ 
  
  // ì›ì •íŒ€ì˜ "ì›ì •ì—ì„œ" ì„±ì 
  away_goalsFor_atAway_avg     Float?
  away_goalsAgainst_atAway_avg Float?
  away_xg_atAway_avg           Float?
  away_wins_atAway_pct         Float?  // ì›ì • ìŠ¹ë¥ 
  
  // ===== V3: í¼ (ìµœê·¼ ê²½ê¸° ê²°ê³¼) =====
  home_form_last3   Float?  // ìµœê·¼ 3ê²½ê¸° ìŠ¹ì  í‰ê·  (ìŠ¹=3, ë¬´=1, íŒ¨=0)
  home_form_last5   Float?  // ìµœê·¼ 5ê²½ê¸° ìŠ¹ì  í‰ê· 
  away_form_last3   Float?
  away_form_last5   Float?
  
  // ===== V3: ë“ì ë ¥/ìˆ˜ë¹„ë ¥ ì°¨ì´ =====
  attack_diff       Float?  // í™ˆ í™ˆë“ì  - ì›ì • ì›ì •ì‹¤ì 
  defense_diff      Float?  // í™ˆ í™ˆì‹¤ì  - ì›ì • ì›ì •ë“ì 

  // ===== V4: ê²½ê¸° í…€/í”¼ë¡œ =====
  home_days_rest        Int?    // í™ˆíŒ€ ë§ˆì§€ë§‰ ê²½ê¸° í›„ íœ´ì‹ì¼
  away_days_rest        Int?    // ì›ì •íŒ€ ë§ˆì§€ë§‰ ê²½ê¸° í›„ íœ´ì‹ì¼
  rest_diff             Int?    // íœ´ì‹ì¼ ì°¨ì´ (+ = í™ˆíŒ€ ìœ ë¦¬)
  
  home_matches_14d      Int?    // í™ˆíŒ€ ìµœê·¼ 14ì¼ê°„ ê²½ê¸° ìˆ˜
  away_matches_14d      Int?    // ì›ì •íŒ€ ìµœê·¼ 14ì¼ê°„ ê²½ê¸° ìˆ˜
  congestion_diff       Int?    // ê²½ê¸° ë°€ì§‘ë„ ì°¨ì´
  
  // ìœ ëŸ½ëŒ€íšŒ í”¼ë¡œ (UCL/Europa)
  home_european_7d      Int?    // í™ˆíŒ€ ìµœê·¼ 7ì¼ ë‚´ ìœ ëŸ½ëŒ€íšŒ ê²½ê¸° ìˆ˜
  away_european_7d      Int?    // ì›ì •íŒ€ ìµœê·¼ 7ì¼ ë‚´ ìœ ëŸ½ëŒ€íšŒ ê²½ê¸° ìˆ˜
  european_diff         Int?    // ìœ ëŸ½ëŒ€íšŒ í”¼ë¡œ ì°¨ì´

  // ===== V5: ìƒëŒ€ì „ì  (H2H) =====
  h2h_total_matches     Int?    // ìµœê·¼ 2ë…„ ë§ëŒ€ê²° íšŸìˆ˜
  h2h_home_wins         Int?    // í™ˆíŒ€ ìŠ¹ë¦¬ íšŸìˆ˜
  h2h_away_wins         Int?    // ì›ì •íŒ€ ìŠ¹ë¦¬ íšŸìˆ˜
  h2h_draws             Int?    // ë¬´ìŠ¹ë¶€ íšŸìˆ˜
  h2h_home_goals_avg    Float?  // í™ˆíŒ€ í‰ê·  ë“ì 
  h2h_away_goals_avg    Float?  // ì›ì •íŒ€ í‰ê·  ë“ì 
  h2h_home_win_pct      Float?  // í™ˆíŒ€ ìŠ¹ë¥ 


  @@index([leagueId, kickoffAt])
  @@index([featureVersion])
}

// ============================================================
// ë‹¤ì¤‘ ë¶ë©”ì´ì»¤ ë°°ë‹¹ ì¶”ì  (Multi-Bookmaker Odds Tracking)
// ============================================================

// ë¶ë©”ì´ì»¤ë³„ ë°°ë‹¹ ìš”ì•½ (ê²½ê¸°ë‹¹ Nê°œ â€” ë¶ë©”ì´ì»¤ë³„ 1ê°œ)
model BookmakerOdds {
  id         BigInt   @id @default(autoincrement())
  fixture    Fixture  @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  fixtureId  BigInt

  bookmaker  String   // "Bet365", "Pinnacle", "1xBet", "Unibet" ë“±

  // ìµœì´ˆ ë°°ë‹¹ (ì²« ìˆ˜ì§‘ ì‹œì )
  openHome   Decimal?
  openDraw   Decimal?
  openAway   Decimal?
  openAt     DateTime?  // ìµœì´ˆ ìˆ˜ì§‘ ì‹œê°

  // í˜„ì¬ ë°°ë‹¹ (ê°€ì¥ ìµœê·¼ ìˆ˜ì§‘)
  currentHome Decimal?
  currentDraw Decimal?
  currentAway Decimal?

  // ë§ˆê° ë°°ë‹¹ (í‚¥ì˜¤í”„ ì§ì „ ë§ˆì§€ë§‰ ìˆ˜ì§‘ â€” ê²½ê¸° ì¢…ë£Œ í›„ ì—…ë°ì´íŠ¸)
  closeHome  Decimal?
  closeDraw  Decimal?
  closeAway  Decimal?
  closeAt    DateTime?

  // ë³€í™”ëŸ‰ (current - open)
  deltaHome  Decimal?  // +0.15 = ë°°ë‹¹ ìƒìŠ¹(í™•ë¥  í•˜ë½), -0.20 = ë°°ë‹¹ í•˜ë½(í™•ë¥  ìƒìŠ¹)
  deltaDraw  Decimal?
  deltaAway  Decimal?

  // ë³€í™” ì†ë„ (ìµœê·¼ 3ì‹œê°„ í‰ê·  ë³€í™”ëŸ‰/ì‹œê°„)
  velocityHome Decimal?
  velocityDraw Decimal?
  velocityAway Decimal?

  // ìˆ˜ì§‘ íšŸìˆ˜
  snapshotCount Int @default(0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // ì‹œê³„ì—´ ìŠ¤ëƒ…ìƒ· (1ì‹œê°„ë§ˆë‹¤ ê¸°ë¡)
  snapshots  BookmakerOddsSnapshot[]

  @@unique([fixtureId, bookmaker])
  @@index([fixtureId])
  @@index([bookmaker])
  @@index([updatedAt])
}

// ë°°ë‹¹ ìŠ¤ëƒ…ìƒ· â€” ì‹œê³„ì—´ (ì´ê²Œ ì§„ì§œ í•µì‹¬ ë°ì´í„°)
model BookmakerOddsSnapshot {
  id              BigInt          @id @default(autoincrement())
  bookmakerOdds   BookmakerOdds   @relation(fields: [bookmakerOddsId], references: [id], onDelete: Cascade)
  bookmakerOddsId BigInt

  home       Decimal
  draw       Decimal
  away       Decimal

  // ì§ì „ ìŠ¤ëƒ…ìƒ· ëŒ€ë¹„ ë³€ë™
  homeChange Decimal?  // +0.05, -0.10 ë“±
  drawChange Decimal?
  awayChange Decimal?

  recordedAt DateTime @default(now())

  @@index([bookmakerOddsId, recordedAt])
  @@index([recordedAt])
}
